#!/bin/sh
#    Copyright (C) 2011 Fundacio Privada per a la Xarxa Oberta, Lliure i Neutral guifi.net
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
#    The full GNU General Public License is included in this distribution in
#    the file called "COPYING".
#
#    This script gives information about bmx6
#    Can be executed from a linux shell: ./bmx6-info -s links
#    Or from web interfae (with cgi enabled): http://host/cgi-bin/bmx6-info?links
#    If you ask for a directory you wil get the directory contents in JSON forman

BMX6_DIR="$(uci get bmx6.general.runtimeDir 2>/dev/null)" || BMX6_DIR="/var/run/bmx6/json"

#Checking if shell mode or cgi-bin mode
if [ "$1" == "-s" ]; then 
	QUERY="$2"
else 
	QUERY="$QUERY_STRING"
	echo "Content-type: text/plain"
	echo ""

fi

check_path() {
        [ -d "$1" ] && path=$(cd $1; pwd)
        [ -f "$1" ] && path=$(cd $1/..; pwd)
        [ $(echo "$path" | grep -c "^$BMX6_DIR") -ne 1 ] && exit 1
}


check_path "$BMX6_DIR/$QUERY"

[ -d "$BMX6_DIR/$QUERY" ] &&
        {
	total=$(ls $BMX6_DIR/$QUERY | wc -w)
	i=1
        echo -n "{ \"$QUERY\": [ "
        for f in $(ls $BMX6_DIR/$QUERY); do
		echo -n "{ \"name\": \"$f\" }"
		[ $i -lt $total ]  && echo -n ','
		i=$(( $i + 1 ))
        done 
        echo -n " ] }"
        exit 0;
        }

[ -f "$BMX6_DIR/$QUERY" ] &&
        {
        cat "$BMX6_DIR/$QUERY";
        exit 0;
        }

ls -1F "$BMX6_DIR"
exit 0

