#!/bin/sh

# Licence: GPLv3
# Part of qmp.cat project
# Maintainer: p4u
#
# This script gives information about bmx6
# Can be executed from a linux shell: ./bmx6-info -s links
# Or from web interfae (with cgi enabled): http://host/cgi-bin/bmx6-info?links
# If you ask for a directory you wil get the directory contents in JSON forman

BMX6_DIR="$(uci get bmx6.general.runtimeDir 2>/dev/null)" || BMX6_DIR="/var/run/bmx6/json"

#Checking if shell mode or cgi-bin mode
if [ "$1" == "-s" ]; then 
	QUERY="$2"
else 
	QUERY="$QUERY_STRING"
	echo "Content-type: text/plain"
	echo ""

fi

check_path() {
        [ -d "$1" ] && path=$(cd $1; pwd)
        [ -f "$1" ] && path=$(cd $1/..; pwd)
        [ $(echo "$path" | grep -c "^$BMX6_DIR") -ne 1 ] && exit 1
}


check_path "$BMX6_DIR/$QUERY"

[ -d "$BMX6_DIR/$QUERY" ] &&
        {
	total=$(ls $BMX6_DIR/$QUERY | wc -w)
	i=1
        echo -n "{ \"$QUERY\": [ "
        for f in $(ls $BMX6_DIR/$QUERY); do
		echo -n "{ \"name\": \"$f\" }"
		[ $i -lt $total ]  && echo -n ','
		i=$(( $i + 1 ))
        done 
        echo -n " ] }"
        exit 0;
        }

[ -f "$BMX6_DIR/$QUERY" ] &&
        {
        cat "$BMX6_DIR/$QUERY";
        exit 0;
        }

ls -1F "$BMX6_DIR"
exit 0

